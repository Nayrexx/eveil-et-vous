<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Images Accueil | √âveil & Vous</title>
    <link href="https://fonts.cdnfonts.com/css/myriad-pro" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Myriad Pro', sans-serif;
            background: linear-gradient(135deg, #FFE5D9 0%, #E5F9F6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            color: #1A1A2E;
            font-size: 2rem;
        }
        
        .header p {
            color: #666;
            font-size: 1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-back {
            background: #4ECDC4;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #FF8C42, #4ECDC4);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        /* Grille des images */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }
        
        .image-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .image-card h3 {
            font-size: 1.3rem;
            color: #1A1A2E;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview.no-image {
            background: linear-gradient(135deg, #FFE5D9, #E5F9F6);
        }
        
        .image-preview.no-image::after {
            content: "Aucune image";
            color: #999;
            font-size: 1rem;
        }
        
        /* Zone de drop */
        .drop-zone {
            border: 3px dashed #4ECDC4;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.05), rgba(255, 140, 66, 0.05));
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #FF8C42;
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.1), rgba(78, 205, 196, 0.1));
            transform: scale(1.02);
        }
        
        .drop-zone .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .drop-zone p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .drop-zone input {
            display: none;
        }
        
        /* Boutons */
        .image-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 0.9rem;
        }
        
        .btn-danger {
            background: #DC2626;
            color: white;
        }
        
        /* Progress bar */
        .upload-progress {
            display: none;
            margin-top: 15px;
        }
        
        .upload-progress.active {
            display: block;
        }
        
        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #FF8C42, #4ECDC4);
            border-radius: 10px;
            transition: width 0.3s;
            width: 0%;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Status message */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .status-message.success {
            display: block;
            background: #D1FAE5;
            color: #065F46;
        }
        
        .status-message.error {
            display: block;
            background: #FEE2E2;
            color: #991B1B;
        }
        
        /* Info box */
        .info-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin-top: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .info-box h3 {
            color: #1A1A2E;
            margin-bottom: 15px;
        }
        
        .info-box p {
            color: #666;
            line-height: 1.8;
        }
        
        .info-box ul {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .info-box li {
            color: #666;
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .images-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üñºÔ∏è Images de l'Accueil</h1>
                <p>Changez les images affich√©es sur la page d'accueil</p>
            </div>
            <div class="header-actions">
                <a href="admin.html" class="btn btn-back">‚Üê Retour Admin</a>
            </div>
        </div>
        
        <div class="images-grid">
            <!-- Image Hero -->
            <div class="image-card">
                <h3>üåü Image Hero (Principale)</h3>
                <div class="image-preview" id="preview-hero">
                    <img src="" alt="Hero" id="img-hero">
                </div>
                <div class="drop-zone" data-target="hero" onclick="document.getElementById('input-hero').click()">
                    <div class="icon">üì§</div>
                    <p>Cliquez ou glissez une image ici</p>
                    <input type="file" id="input-hero" accept="image/*">
                </div>
                <div class="upload-progress" id="progress-hero">
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">Upload en cours...</div>
                </div>
                <div class="status-message" id="status-hero"></div>
            </div>
            
            <!-- Image D√¥me 1 -->
            <div class="image-card">
                <h3>üèïÔ∏è D√¥me 1</h3>
                <div class="image-preview" id="preview-dome1">
                    <img src="" alt="D√¥me 1" id="img-dome1">
                </div>
                <div class="drop-zone" data-target="dome1" onclick="document.getElementById('input-dome1').click()">
                    <div class="icon">üì§</div>
                    <p>Cliquez ou glissez une image ici</p>
                    <input type="file" id="input-dome1" accept="image/*">
                </div>
                <div class="upload-progress" id="progress-dome1">
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">Upload en cours...</div>
                </div>
                <div class="status-message" id="status-dome1"></div>
            </div>
            
            <!-- Image D√¥me 2 -->
            <div class="image-card">
                <h3>üèïÔ∏è D√¥me 2</h3>
                <div class="image-preview" id="preview-dome2">
                    <img src="" alt="D√¥me 2" id="img-dome2">
                </div>
                <div class="drop-zone" data-target="dome2" onclick="document.getElementById('input-dome2').click()">
                    <div class="icon">üì§</div>
                    <p>Cliquez ou glissez une image ici</p>
                    <input type="file" id="input-dome2" accept="image/*">
                </div>
                <div class="upload-progress" id="progress-dome2">
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">Upload en cours...</div>
                </div>
                <div class="status-message" id="status-dome2"></div>
            </div>
            
            <!-- Image D√¥me 3 -->
            <div class="image-card">
                <h3>üèïÔ∏è D√¥me 3</h3>
                <div class="image-preview" id="preview-dome3">
                    <img src="" alt="D√¥me 3" id="img-dome3">
                </div>
                <div class="drop-zone" data-target="dome3" onclick="document.getElementById('input-dome3').click()">
                    <div class="icon">üì§</div>
                    <p>Cliquez ou glissez une image ici</p>
                    <input type="file" id="input-dome3" accept="image/*">
                </div>
                <div class="upload-progress" id="progress-dome3">
                    <div class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">Upload en cours...</div>
                </div>
                <div class="status-message" id="status-dome3"></div>
            </div>
        </div>
        
        <div class="info-box">
            <h3>üí° Comment √ßa marche ?</h3>
            <p>Les images sont upload√©es sur ImgBB (gratuit et illimit√©) et les URLs sont sauvegard√©es dans Firebase.</p>
            <ul>
                <li><strong>Image Hero :</strong> L'image principale en haut de la page d'accueil</li>
                <li><strong>D√¥mes 1, 2, 3 :</strong> Les 3 images de la section h√©bergement</li>
            </ul>
            <p>‚ö†Ô∏è <strong>Formats accept√©s :</strong> JPG, PNG, WEBP (max 32MB)</p>
        </div>
    </div>
    
    <script>
        // V√©rifier la connexion admin Firebase
        checkAdminAuth().then(() => {
            // Initialiser Firebase via firebase-config.js
            initFirebase();
            loadImages();
        });
        
        // Configuration ImgBB
        const IMGBB_API_KEY = 'eb10481445fa1c4e3d182ac81380a460';
        
        // Initialiser Firebase via firebase-config.js
        initFirebase();
        
        // Images par d√©faut (locales)
        const defaultImages = {
            hero: 'images/image accueil.jpg',
            dome1: 'images/domes.png',
            dome2: 'images/domes2.png',
            dome3: 'images/domes3.png'
        };
        
        // Charger les images au d√©marrage
        async function loadImages() {
            try {
                const doc = await db.collection('settings').doc('homepage-images').get();
                const data = doc.exists ? doc.data() : {};
                
                // Afficher les images (Firebase ou d√©faut)
                for (const [key, defaultSrc] of Object.entries(defaultImages)) {
                    const imgElement = document.getElementById(`img-${key}`);
                    const src = data[key] || defaultSrc;
                    imgElement.src = src;
                    imgElement.onerror = () => imgElement.src = defaultSrc;
                }
                
                console.log('‚úÖ Images charg√©es');
            } catch (error) {
                console.error('Erreur chargement images:', error);
                // Afficher images par d√©faut en cas d'erreur
                for (const [key, defaultSrc] of Object.entries(defaultImages)) {
                    document.getElementById(`img-${key}`).src = defaultSrc;
                }
            }
        }
        
        // Upload vers ImgBB
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', IMGBB_API_KEY);
            
            const response = await fetch('https://api.imgbb.com/1/upload', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                return data.data.url;
            } else {
                throw new Error('Erreur upload ImgBB');
            }
        }
        
        // Sauvegarder URL dans Firebase
        async function saveImageUrl(imageKey, url) {
            try {
                await db.collection('settings').doc('homepage-images').set({
                    [imageKey]: url
                }, { merge: true });
                
                console.log(`‚úÖ Image ${imageKey} sauvegard√©e`);
                return true;
            } catch (error) {
                console.error('Erreur sauvegarde Firebase:', error);
                throw error;
            }
        }
        
        // G√©rer l'upload d'une image
        async function handleUpload(imageKey, file) {
            const progressDiv = document.getElementById(`progress-${imageKey}`);
            const statusDiv = document.getElementById(`status-${imageKey}`);
            const imgElement = document.getElementById(`img-${imageKey}`);
            const progressFill = progressDiv.querySelector('.progress-bar-fill');
            
            // Reset
            statusDiv.className = 'status-message';
            statusDiv.textContent = '';
            progressDiv.classList.add('active');
            progressFill.style.width = '0%';
            
            try {
                // √âtape 1: Upload vers ImgBB (50%)
                progressFill.style.width = '30%';
                const imageUrl = await uploadToImgBB(file);
                progressFill.style.width = '70%';
                
                // √âtape 2: Sauvegarder dans Firebase (100%)
                await saveImageUrl(imageKey, imageUrl);
                progressFill.style.width = '100%';
                
                // Mettre √† jour l'aper√ßu
                imgElement.src = imageUrl;
                
                // Afficher succ√®s
                setTimeout(() => {
                    progressDiv.classList.remove('active');
                    statusDiv.className = 'status-message success';
                    statusDiv.textContent = '‚úÖ Image mise √† jour avec succ√®s !';
                }, 500);
                
            } catch (error) {
                console.error('Erreur upload:', error);
                progressDiv.classList.remove('active');
                statusDiv.className = 'status-message error';
                statusDiv.textContent = '‚ùå Erreur lors de l\'upload. R√©essayez.';
            }
        }
        
        // Event listeners pour les inputs file
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', (e) => {
                console.log('üìÅ Fichier s√©lectionn√©:', e.target.files[0]);
                const file = e.target.files[0];
                if (file) {
                    const imageKey = input.id.replace('input-', '');
                    console.log('üîë Image key:', imageKey);
                    handleUpload(imageKey, file);
                }
            });
        });
        
        // Drag & Drop
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const imageKey = zone.dataset.target;
                    handleUpload(imageKey, file);
                }
            });
        });
        
        // Charger les images au d√©marrage
        loadImages();
    </script>
</body>
</html>
