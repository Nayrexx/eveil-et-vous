<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration R√©servations | √âveil & Vous</title>
    <link href="https://fonts.cdnfonts.com/css/myriad-pro" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --corail: #FF6B6B;
            --turquoise: #4ECDC4;
            --lavande: #A78BFA;
            --rose: #FF6B9D;
            --vert: #6BCF7F;
            --orange: #FF8C42;
        }
        
        body {
            font-family: 'Myriad Pro', Arial, sans-serif;
            background: linear-gradient(135deg, #FFE5D9 0%, #E5F9F6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 25px 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #1A1A2E;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-back {
            background: var(--turquoise);
            color: white;
        }
        
        .btn-export {
            background: #9C27B0;
            color: white;
        }
        
        .btn-danger {
            background: #EF4444;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        .stat-card .number {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--orange), var(--turquoise));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-card .label {
            color: #666;
            font-size: 1rem;
            margin-top: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 25px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .tab:hover {
            border-color: var(--turquoise);
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--orange), var(--turquoise));
            color: white;
            border-color: transparent;
        }
        
        /* Sections */
        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        }
        
        .section h2 {
            font-size: 1.5rem;
            color: #1A1A2E;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Ateliers Grid */
        .ateliers-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .atelier-admin-card {
            background: #f9fafb;
            border-radius: 15px;
            padding: 20px;
            border-left: 5px solid var(--turquoise);
            transition: all 0.3s;
        }
        
        .atelier-admin-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .atelier-admin-card.complet {
            border-left-color: #EF4444;
            opacity: 0.8;
        }
        
        .atelier-admin-card.solo {
            border-left-color: var(--corail);
        }
        
        .atelier-admin-card.duo {
            border-left-color: var(--turquoise);
        }
        
        .atelier-admin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .atelier-admin-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1A1A2E;
        }
        
        .atelier-admin-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-solo {
            background: rgba(255, 107, 107, 0.15);
            color: #DC2626;
        }
        
        .badge-duo {
            background: rgba(78, 205, 196, 0.15);
            color: #0D9488;
        }
        
        .atelier-admin-info {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .atelier-admin-places {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .places-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .places-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .places-fill.ok { background: var(--vert); }
        .places-fill.warning { background: #F59E0B; }
        .places-fill.danger { background: #EF4444; }
        
        .places-text {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .atelier-admin-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-small:hover {
            transform: scale(1.02);
        }
        
        .btn-complet {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .btn-rouvrir {
            background: #D1FAE5;
            color: #059669;
        }
        
        .btn-edit {
            background: #E0E7FF;
            color: #4F46E5;
        }
        
        /* R√©servations Table */
        .reservations-container {
            overflow-x: auto;
        }
        
        .reservations-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .reservations-table th,
        .reservations-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .reservations-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #1A1A2E;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .reservations-table tr:hover {
            background: #f9fafb;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-confirmee {
            background: #D1FAE5;
            color: #059669;
        }
        
        .status-annulee {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            transform: scale(1.05);
        }
        
        .action-btn.view { background: #E0E7FF; color: #4F46E5; }
        .action-btn.cancel { background: #FEE2E2; color: #DC2626; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            padding: 30px;
            position: relative;
        }
        
        .modal h3 {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1A1A2E;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f3f4f6;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1A1A2E;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--turquoise);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 18px 28px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10001;
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { border-left: 5px solid #10B981; }
        .toast.error { border-left: 5px solid #EF4444; }
        .toast.warning { border-left: 5px solid #F59E0B; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üìã Gestion des R√©servations</h1>
                <p style="color: #666; margin-top: 5px;">G√©rez les ateliers et les r√©servations</p>
            </div>
            <div class="header-actions">
                <a href="admin.html" class="btn btn-back">‚Üê Retour Admin</a>
                <button class="btn btn-export" onclick="exportReservations()">üì• Exporter CSV</button>
                <button class="btn btn-danger" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="statReservations">0</div>
                <div class="label">R√©servations totales</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statAteliersComplets">0</div>
                <div class="label">Ateliers complets</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statPlacesRestantes">0</div>
                <div class="label">Places restantes</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statRevenu">0‚Ç¨</div>
                <div class="label">Revenu estim√©</div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="ateliers">üé® Ateliers (16)</button>
            <button class="tab" data-tab="reservations">üìù R√©servations</button>
            <button class="tab" data-tab="waitlist">üîî Liste d'attente</button>
            <button class="tab" data-tab="emailing">üìß Emailing</button>
            <button class="tab" data-tab="parametres">‚öôÔ∏è Param√®tres</button>
        </div>
        
        <!-- Section Ateliers -->
        <div class="section" id="sectionAteliers">
            <h2>üóìÔ∏è Gestion des 16 Ateliers</h2>
            
            <div style="margin-bottom: 20px;">
                <select id="filterType" onchange="renderAteliers()" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit;">
                    <option value="all">Tous les ateliers</option>
                    <option value="solo">E&V Solo uniquement</option>
                    <option value="duo">E&V Duo uniquement</option>
                    <option value="complet">Ateliers complets</option>
                    <option value="disponible">Places disponibles</option>
                </select>
            </div>
            
            <div class="ateliers-admin-grid" id="ateliersGrid">
                <!-- G√©n√©r√© dynamiquement -->
            </div>
        </div>
        
        <!-- Section R√©servations -->
        <div class="section" id="sectionReservations" style="display: none;">
            <h2>üìù Liste des R√©servations</h2>
            
            <div class="reservations-container">
                <table class="reservations-table" id="reservationsTable">
                    <thead>
                        <tr>
                            <th>N¬∞</th>
                            <th>Atelier</th>
                            <th>Date</th>
                            <th>Parent</th>
                            <th>Enfant</th>
                            <th>Contact</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="empty-state" id="emptyReservations" style="display: none;">
                <div class="icon">üì≠</div>
                <h3>Aucune r√©servation</h3>
                <p>Les r√©servations appara√Ætront ici</p>
            </div>
        </div>
        
        <!-- Section Liste d'attente -->
        <div class="section" id="sectionWaitlist" style="display: none;">
            <h2>üîî Liste d'attente</h2>
            <p style="color: #666; margin-bottom: 20px;">Personnes inscrites pour √™tre notifi√©es si une place se lib√®re.</p>
            
            <div class="reservations-container">
                <table class="reservations-table" id="waitlistTable">
                    <thead>
                        <tr>
                            <th>Atelier</th>
                            <th>Date atelier</th>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>T√©l√©phone</th>
                            <th>Inscrit le</th>
                            <th>Notifi√©</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="waitlistBody">
                        <!-- G√©n√©r√© dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="empty-state" id="emptyWaitlist" style="display: none;">
                <div class="icon">üì≠</div>
                <h3>Aucune inscription en liste d'attente</h3>
                <p>Les inscriptions appara√Ætront ici quand des ateliers seront complets</p>
            </div>
        </div>
        
        <!-- Section Emailing -->
        <div class="section" id="sectionEmailing" style="display: none;">
            <h2>üìß Emailing Group√©</h2>
            <p style="color: #666; margin-bottom: 25px;">Envoyez un email √† tous les inscrits d'un atelier sp√©cifique.</p>
            
            <div style="max-width: 600px;">
                <div class="form-group">
                    <label>üéØ S√©lectionner l'atelier</label>
                    <select id="emailAtelierId" onchange="updateEmailRecipients()" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit;">
                        <option value="">-- Choisir un atelier --</option>
                        <option value="all">üì¢ TOUS les inscrits (tous ateliers)</option>
                    </select>
                </div>
                
                <div id="emailRecipientsInfo" style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                    <strong>üë• Destinataires :</strong> <span id="emailRecipientsCount">0</span> personne(s)
                    <div id="emailRecipientsList" style="font-size: 0.85rem; color: #666; margin-top: 5px;"></div>
                </div>
                
                <div class="form-group">
                    <label>üìù Objet de l'email</label>
                    <input type="text" id="emailSubject" placeholder="Ex: Rappel atelier de demain !">
                </div>
                
                <div class="form-group">
                    <label>‚úâÔ∏è Message</label>
                    <textarea id="emailMessage" rows="8" style="width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit; resize: vertical;" placeholder="Bonjour {nom},

Nous vous rappelons que l'atelier {atelier} aura lieu le {date} √† {heure}.

√Ä tr√®s bient√¥t !
L'√©quipe √âveil & Vous"></textarea>
                </div>
                
                <div style="background: #FEF3C7; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong>üí° Variables disponibles :</strong><br>
                    <code>{nom}</code> - Nom du parent<br>
                    <code>{enfant}</code> - Pr√©nom de l'enfant<br>
                    <code>{atelier}</code> - Nom de l'atelier<br>
                    <code>{date}</code> - Date de l'atelier<br>
                    <code>{heure}</code> - Horaire
                </div>
                
                <button class="btn" style="background: linear-gradient(135deg, #9333EA, #EC4899); color: white; width: 100%;" onclick="sendGroupEmail()">
                    üìß Envoyer l'email group√©
                </button>
            </div>
        </div>
        
        <!-- Section Param√®tres -->
        <div class="section" id="sectionParametres" style="display: none;">
            <h2>‚öôÔ∏è Param√®tres</h2>
            
            <div style="max-width: 500px;">
                <!-- Firebase Status -->
                <div id="firebaseStatusBox" style="background: #F0FDF4; border: 2px solid #10B981; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                    <h3 style="color: #10B981; margin-bottom: 10px;">üî• Firebase Database</h3>
                    <p id="firebaseStatusText" style="color: #065F46;">Connect√© - Donn√©es synchronis√©es en temps r√©el</p>
                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="syncFromFirebase()" style="background: #10B981; color: white;">
                            üîÑ Rafra√Æchir depuis Firebase
                        </button>
                        <button class="btn" onclick="migrateToFirebase()" style="background: #F59E0B; color: white;">
                            üì§ Migrer vers Firebase
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìß Email de notification admin</label>
                    <input type="email" id="adminEmail" value="contact@eveiletvouss.fr">
                </div>
                
                <div class="form-group">
                    <label>üë• Places max par atelier Solo</label>
                    <input type="number" id="maxPlacesSolo" value="8" min="1" max="20">
                </div>
                
                <div class="form-group">
                    <label>üë• Places max par atelier Duo</label>
                    <input type="number" id="maxPlacesDuo" value="6" min="1" max="20">
                </div>
                
                <button class="btn" style="background: linear-gradient(135deg, var(--orange), var(--turquoise)); color: white;" onclick="saveSettings()">
                    üíæ Sauvegarder les param√®tres
                </button>
                
                <hr style="margin: 30px 0; border: none; border-top: 2px dashed #e5e7eb;">
                
                <h3 style="margin-bottom: 15px; color: #DC2626;">‚ö†Ô∏è Zone dangereuse</h3>
                
                <button class="btn btn-danger" onclick="resetAllData()">
                    üóëÔ∏è R√©initialiser toutes les donn√©es
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal √âdition Places -->
    <div class="modal-overlay" id="modalEdit">
        <div class="modal">
            <button class="modal-close" onclick="closeEditModal()">√ó</button>
            <h3 id="modalEditTitle">Modifier l'atelier</h3>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editType">
                
                <div class="form-group">
                    <label>üé® Nom de l'atelier</label>
                    <input type="text" id="editTitre" placeholder="Ex: √âveil Cr√©atif">
                </div>
                
                <div class="form-group">
                    <label>üòÄ Emoji</label>
                    <input type="text" id="editEmoji" placeholder="Ex: üé®" style="font-size: 1.5rem; text-align: center;">
                </div>
                
                <div class="form-group">
                    <label>ÔøΩ Description</label>
                    <textarea id="editDescription" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ÔøΩüìÖ Date</label>
                    <input type="text" id="editDate" placeholder="Ex: Mercredi 15 Janvier 2025">
                </div>
                
                <div class="form-group">
                    <label>‚è∞ Horaire</label>
                    <input type="text" id="editHeure" placeholder="Ex: 14h30 - 16h00">
                </div>
                
                <div class="form-group">
                    <label>üë• Places restantes</label>
                    <input type="number" id="editPlaces" min="0" max="20">
                </div>
                
                <button type="submit" class="btn" style="width: 100%; background: linear-gradient(135deg, var(--orange), var(--turquoise)); color: white;">
                    üíæ Enregistrer les modifications
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal D√©tails R√©servation -->
    <div class="modal-overlay" id="modalDetails">
        <div class="modal">
            <button class="modal-close" onclick="closeDetailsModal()">√ó</button>
            <h3>üìã D√©tails de la r√©servation</h3>
            <div id="reservationDetails"></div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úÖ</span>
        <span id="toastMessage">Message</span>
    </div>

    <script>
        // =============================================
        // DONN√âES
        // =============================================
        
        let ateliersData = { ateliersSolo: [], ateliersDuo: [] };
        let reservations = [];
        
        // Donn√©es par d√©faut
        const defaultData = {
            ateliersSolo: [
                { id: 1, titre: "√âveil Cr√©atif", emoji: "üé®", date: "Mercredi 15 Janvier 2025", heure: "14h30 - 16h00", description: "Arts plastiques et expression artistique.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 8, complet: false, couleur: "#FF6B6B" },
                { id: 2, titre: "√âveil Sensoriel", emoji: "üëÉ", date: "Mercredi 22 Janvier 2025", heure: "14h30 - 16h00", description: "D√©couverte des 5 sens.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 5, complet: false, couleur: "#4ECDC4" },
                { id: 3, titre: "Yoga & Relaxation", emoji: "üßò", date: "Mercredi 29 Janvier 2025", heure: "14h30 - 16h00", description: "Postures ludiques et relaxation.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 6, complet: false, couleur: "#A78BFA" },
                { id: 4, titre: "Gestion des √âmotions", emoji: "‚ù§Ô∏è", date: "Mercredi 5 F√©vrier 2025", heure: "14h30 - 16h00", description: "Identifier et accueillir ses √©motions.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 7, complet: false, couleur: "#FF6B9D" },
                { id: 5, titre: "Activit√©s Nature", emoji: "üå≥", date: "Mercredi 12 F√©vrier 2025", heure: "14h30 - 16h00", description: "Jardinage et land art.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 8, complet: false, couleur: "#6BCF7F" },
                { id: 6, titre: "√âveil Cr√©atif", emoji: "üé®", date: "Mercredi 19 F√©vrier 2025", heure: "14h30 - 16h00", description: "Nouvelles techniques artistiques.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 8, complet: false, couleur: "#FF6B6B" },
                { id: 7, titre: "√âveil Sensoriel", emoji: "üëÉ", date: "Mercredi 26 F√©vrier 2025", heure: "14h30 - 16h00", description: "Explorations sensorielles.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 6, complet: false, couleur: "#4ECDC4" },
                { id: 8, titre: "Yoga & Relaxation", emoji: "üßò", date: "Mercredi 5 Mars 2025", heure: "14h30 - 16h00", description: "Approfondissement yoga.", prix: 18, prixAffiche: "18‚Ç¨ TTC", placesMax: 8, placesRestantes: 7, complet: false, couleur: "#A78BFA" }
            ],
            ateliersDuo: [
                { id: 9, titre: "√âveil Cr√©atif en Duo", emoji: "üé®", date: "Samedi 18 Janvier 2025", heure: "10h00 - 12h00", description: "Cr√©ation artistique en bin√¥me.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 6, complet: false, couleur: "#FF6B6B" },
                { id: 10, titre: "√âveil Sensoriel en Duo", emoji: "üëÉ", date: "Samedi 25 Janvier 2025", heure: "10h00 - 12h00", description: "Exploration des sens ensemble.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 5, complet: false, couleur: "#4ECDC4" },
                { id: 11, titre: "Yoga & Relaxation en Duo", emoji: "üßò", date: "Samedi 1er F√©vrier 2025", heure: "10h00 - 12h00", description: "Yoga en bin√¥me.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 6, complet: false, couleur: "#A78BFA" },
                { id: 12, titre: "Gestion des √âmotions en Duo", emoji: "‚ù§Ô∏è", date: "Samedi 8 F√©vrier 2025", heure: "10h00 - 12h00", description: "√âmotions en famille.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 6, complet: false, couleur: "#FF6B9D" },
                { id: 13, titre: "Activit√©s Nature en Duo", emoji: "üå≥", date: "Samedi 15 F√©vrier 2025", heure: "10h00 - 12h00", description: "Nature en famille.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 7, complet: false, couleur: "#6BCF7F" },
                { id: 14, titre: "√âveil Cr√©atif en Duo", emoji: "üé®", date: "Samedi 22 F√©vrier 2025", heure: "10h00 - 12h00", description: "Nouvelles techniques duo.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 6, complet: false, couleur: "#FF6B6B" },
                { id: 15, titre: "√âveil Sensoriel en Duo", emoji: "üëÉ", date: "Samedi 1er Mars 2025", heure: "10h00 - 12h00", description: "Sensorialit√© partag√©e.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 5, complet: false, couleur: "#4ECDC4" },
                { id: 16, titre: "Yoga & Relaxation en Duo", emoji: "üßò", date: "Samedi 8 Mars 2025", heure: "10h00 - 12h00", description: "Yoga duo approfondi.", prix: 18, prixAffiche: "18‚Ç¨ TTC/duo", placesMax: 6, placesRestantes: 6, complet: false, couleur: "#A78BFA" }
            ]
        };
        
        // Flag Firebase
        let firebaseReady = false;
        let waitlistData = [];
        
        // =============================================
        // INITIALISATION
        // =============================================
        
        async function init() {
            // V√©rifier connexion admin Firebase
            try {
                await checkAdminAuth();
            } catch (e) {
                return; // Redirection g√©r√©e par checkAdminAuth
            }
            
            // Initialiser Firebase
            try {
                FirebaseDB.init();
                firebaseReady = true;
                console.log('üî• Firebase Admin pr√™t');
                
                // Activer l'√©coute en temps r√©el
                setupAdminRealtimeListeners();
            } catch (e) {
                console.warn('‚ö†Ô∏è Firebase non disponible, utilisation localStorage:', e);
                firebaseReady = false;
            }
            
            await loadData();
            renderAteliers();
            renderReservations();
            renderWaitlist();
            populateEmailAtelierSelect();
            updateStats();
            initTabs();
            initEditForm();
            
            // Afficher indicateur Firebase
            showFirebaseStatus();
        }
        
        // =============================================
        // √âCOUTE EN TEMPS R√âEL FIREBASE (ADMIN)
        // =============================================
        
        function setupAdminRealtimeListeners() {
            if (!firebaseReady) return;
            
            console.log('üëÇ Activation √©coute temps r√©el Admin...');
            
            // √âcouter les changements sur ateliersSolo
            db.collection('ateliers').doc('ateliersSolo').onSnapshot((doc) => {
                if (doc.exists && doc.data().items) {
                    ateliersData.ateliersSolo = doc.data().items;
                    renderAteliers();
                    updateStats();
                    console.log('üîÑ Admin: Ateliers Solo mis √† jour');
                }
            });
            
            // √âcouter les changements sur ateliersDuo
            db.collection('ateliers').doc('ateliersDuo').onSnapshot((doc) => {
                if (doc.exists && doc.data().items) {
                    ateliersData.ateliersDuo = doc.data().items;
                    renderAteliers();
                    updateStats();
                    console.log('üîÑ Admin: Ateliers Duo mis √† jour');
                }
            });
            
            // √âcouter les nouvelles r√©servations
            db.collection('reservations').onSnapshot((snapshot) => {
                reservations = [];
                snapshot.forEach(doc => {
                    reservations.push({ id: doc.id, ...doc.data() });
                });
                renderReservations();
                updateStats();
                console.log('üîÑ Admin: R√©servations mises √† jour');
            });
            
            // √âcouter la liste d'attente
            db.collection('waitlist').onSnapshot((snapshot) => {
                waitlistData = [];
                snapshot.forEach(doc => {
                    waitlistData.push({ id: doc.id, ...doc.data() });
                });
                renderWaitlist();
                console.log('üîÑ Admin: Liste d\'attente mise √† jour');
            });
        }
        
        function showFirebaseStatus() {
            const header = document.querySelector('.header p');
            if (firebaseReady) {
                header.innerHTML = 'G√©rez les ateliers et les r√©servations <span style="background: #10B981; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 10px;">üî• Firebase connect√© - Temps r√©el</span>';
            } else {
                header.innerHTML = 'G√©rez les ateliers et les r√©servations <span style="background: #F59E0B; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 10px;">üíæ Mode local</span>';
            }
            
            // Mettre √† jour aussi le box des param√®tres
            setTimeout(updateFirebaseStatusBox, 100);
        }
        
        async function loadData() {
            if (firebaseReady) {
                try {
                    // Charger les ateliers depuis Firebase
                    const soloDoc = await db.collection('ateliers').doc('ateliersSolo').get();
                    const duoDoc = await db.collection('ateliers').doc('ateliersDuo').get();
                    
                    if (soloDoc.exists && duoDoc.exists) {
                        ateliersData.ateliersSolo = soloDoc.data().items || [];
                        ateliersData.ateliersDuo = duoDoc.data().items || [];
                    } else {
                        // Premi√®re utilisation, sauvegarder les donn√©es par d√©faut
                        ateliersData = JSON.parse(JSON.stringify(defaultData));
                        await saveData();
                    }
                    
                    // Charger les r√©servations
                    reservations = await FirebaseDB.getReservations();
                    
                    // Charger la liste d'attente
                    waitlistData = await FirebaseDB.getWaitlist();
                    
                    console.log('‚úÖ Donn√©es charg√©es depuis Firebase');
                } catch (e) {
                    console.error('Erreur Firebase, fallback localStorage:', e);
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            const savedAteliers = localStorage.getItem('ateliers-reservations-data');
            if (savedAteliers) {
                ateliersData = JSON.parse(savedAteliers);
            } else {
                ateliersData = JSON.parse(JSON.stringify(defaultData));
            }
            
            const savedReservations = localStorage.getItem('reservations-list');
            if (savedReservations) {
                reservations = JSON.parse(savedReservations);
            }
            
            waitlistData = JSON.parse(localStorage.getItem('waitlist-data')) || [];
        }
        
        async function saveData() {
            // Toujours sauvegarder en local comme backup
            localStorage.setItem('ateliers-reservations-data', JSON.stringify(ateliersData));
            localStorage.setItem('reservations-list', JSON.stringify(reservations));
            
            // Sauvegarder dans Firebase si disponible
            if (firebaseReady) {
                try {
                    await db.collection('ateliers').doc('ateliersSolo').set({ items: ateliersData.ateliersSolo });
                    await db.collection('ateliers').doc('ateliersDuo').set({ items: ateliersData.ateliersDuo });
                    console.log('‚úÖ Donn√©es sauvegard√©es dans Firebase');
                } catch (e) {
                    console.error('Erreur sauvegarde Firebase:', e);
                }
            }
        }
        
        // =============================================
        // TABS
        // =============================================
        
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.getElementById('sectionAteliers').style.display = 'none';
                    document.getElementById('sectionReservations').style.display = 'none';
                    document.getElementById('sectionWaitlist').style.display = 'none';
                    document.getElementById('sectionEmailing').style.display = 'none';
                    document.getElementById('sectionParametres').style.display = 'none';
                    
                    document.getElementById('section' + capitalizeFirst(tab.dataset.tab)).style.display = 'block';
                });
            });
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        // =============================================
        // STATS
        // =============================================
        
        function updateStats() {
            const allAteliers = [...ateliersData.ateliersSolo, ...ateliersData.ateliersDuo];
            const complets = allAteliers.filter(a => a.complet).length;
            const placesRestantes = allAteliers.reduce((sum, a) => sum + a.placesRestantes, 0);
            const reservationsConfirmees = reservations.filter(r => r.statut === 'confirm√©e').length;
            const revenu = reservationsConfirmees * 18;
            
            document.getElementById('statReservations').textContent = reservationsConfirmees;
            document.getElementById('statAteliersComplets').textContent = complets;
            document.getElementById('statPlacesRestantes').textContent = placesRestantes;
            document.getElementById('statRevenu').textContent = revenu + '‚Ç¨';
        }
        
        // =============================================
        // ATELIERS
        // =============================================
        
        function renderAteliers() {
            const filter = document.getElementById('filterType').value;
            let allAteliers = [];
            
            ateliersData.ateliersSolo.forEach(a => allAteliers.push({...a, type: 'solo'}));
            ateliersData.ateliersDuo.forEach(a => allAteliers.push({...a, type: 'duo'}));
            
            // Filtrer
            if (filter === 'solo') allAteliers = allAteliers.filter(a => a.type === 'solo');
            if (filter === 'duo') allAteliers = allAteliers.filter(a => a.type === 'duo');
            if (filter === 'complet') allAteliers = allAteliers.filter(a => a.complet);
            if (filter === 'disponible') allAteliers = allAteliers.filter(a => !a.complet);
            
            const grid = document.getElementById('ateliersGrid');
            grid.innerHTML = allAteliers.map(a => createAtelierCard(a)).join('');
        }
        
        function createAtelierCard(atelier) {
            const pourcent = ((atelier.placesMax - atelier.placesRestantes) / atelier.placesMax) * 100;
            const fillClass = pourcent >= 100 ? 'danger' : (pourcent >= 75 ? 'warning' : 'ok');
            
            return `
                <div class="atelier-admin-card ${atelier.type} ${atelier.complet ? 'complet' : ''}">
                    <div class="atelier-admin-header">
                        <div>
                            <span style="font-size: 1.5rem;">${atelier.emoji}</span>
                            <div class="atelier-admin-title">${atelier.titre}</div>
                        </div>
                        <span class="atelier-admin-badge badge-${atelier.type}">${atelier.type === 'solo' ? 'Solo' : 'Duo'}</span>
                    </div>
                    <div class="atelier-admin-info">
                        üìÖ ${atelier.date}<br>
                        ‚è∞ ${atelier.heure}
                    </div>
                    <div class="atelier-admin-places">
                        <div class="places-bar">
                            <div class="places-fill ${fillClass}" style="width: ${pourcent}%"></div>
                        </div>
                        <span class="places-text">${atelier.placesRestantes}/${atelier.placesMax}</span>
                    </div>
                    <div class="atelier-admin-actions">
                        ${atelier.complet 
                            ? `<button class="btn-small btn-rouvrir" onclick="rouvrirAtelier(${atelier.id}, '${atelier.type}')">üîì Rouvrir</button>`
                            : `<button class="btn-small btn-complet" onclick="marquerComplet(${atelier.id}, '${atelier.type}')">üîí Complet</button>`
                        }
                        <button class="btn-small btn-edit" onclick="openEditModal(${atelier.id}, '${atelier.type}')">‚úèÔ∏è √âditer</button>
                    </div>
                </div>
            `;
        }
        
        function marquerComplet(id, type) {
            const source = type === 'solo' ? ateliersData.ateliersSolo : ateliersData.ateliersDuo;
            const atelier = source.find(a => a.id === id);
            if (atelier) {
                atelier.complet = true;
                atelier.placesRestantes = 0;
                saveData();
                renderAteliers();
                updateStats();
                showToast('‚úÖ Atelier marqu√© comme complet', 'success');
            }
        }
        
        function rouvrirAtelier(id, type) {
            const source = type === 'solo' ? ateliersData.ateliersSolo : ateliersData.ateliersDuo;
            const atelier = source.find(a => a.id === id);
            if (atelier) {
                atelier.complet = false;
                atelier.placesRestantes = 1; // Au moins une place
                saveData();
                renderAteliers();
                updateStats();
                showToast('‚úÖ Atelier r√©ouvert', 'success');
            }
        }
        
        // =============================================
        // MODAL √âDITION
        // =============================================
        
        function openEditModal(id, type) {
            const source = type === 'solo' ? ateliersData.ateliersSolo : ateliersData.ateliersDuo;
            const atelier = source.find(a => a.id === id);
            if (!atelier) return;
            
            document.getElementById('modalEditTitle').textContent = `Modifier: ${atelier.titre}`;
            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editTitre').value = atelier.titre;
            document.getElementById('editEmoji').value = atelier.emoji;
            document.getElementById('editDescription').value = atelier.description || '';
            document.getElementById('editDate').value = atelier.date;
            document.getElementById('editHeure').value = atelier.heure;
            document.getElementById('editPlaces').value = atelier.placesRestantes;
            document.getElementById('editPlaces').max = atelier.placesMax;
            
            document.getElementById('modalEdit').classList.add('active');
        }
        
        function closeEditModal() {
            document.getElementById('modalEdit').classList.remove('active');
        }
        
        function initEditForm() {
            document.getElementById('editForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editId').value);
                const type = document.getElementById('editType').value;
                const source = type === 'solo' ? ateliersData.ateliersSolo : ateliersData.ateliersDuo;
                const atelier = source.find(a => a.id === id);
                
                if (atelier) {
                    atelier.titre = document.getElementById('editTitre').value;
                    atelier.emoji = document.getElementById('editEmoji').value;
                    atelier.description = document.getElementById('editDescription').value;
                    atelier.date = document.getElementById('editDate').value;
                    atelier.heure = document.getElementById('editHeure').value;
                    atelier.placesRestantes = parseInt(document.getElementById('editPlaces').value);
                    atelier.complet = atelier.placesRestantes <= 0;
                    
                    saveData();
                    renderAteliers();
                    updateStats();
                    closeEditModal();
                    showToast('‚úÖ Atelier mis √† jour', 'success');
                }
            });
        }
        
        // =============================================
        // R√âSERVATIONS
        // =============================================
        
        function renderReservations() {
            const tbody = document.getElementById('reservationsBody');
            const empty = document.getElementById('emptyReservations');
            
            if (reservations.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            
            tbody.innerHTML = reservations.map(r => `
                <tr>
                    <td>#${r.id}</td>
                    <td><strong>${r.atelierTitre}</strong></td>
                    <td>${r.atelierDate}<br><small>${r.atelierHeure}</small></td>
                    <td>${r.parentNom}</td>
                    <td>${r.enfantPrenom} (${r.enfantAge} ans)</td>
                    <td>${r.parentEmail}<br><small>${r.parentTel}</small></td>
                    <td><span class="status-badge status-${r.statut}">${r.statut}</span></td>
                    <td>
                        <button class="action-btn view" onclick="viewReservation(${r.id})">üëÅÔ∏è</button>
                        ${r.statut === 'confirm√©e' ? `<button class="action-btn cancel" onclick="cancelReservation(${r.id})">‚ùå</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }
        
        function viewReservation(id) {
            const r = reservations.find(res => res.id === id);
            if (!r) return;
            
            document.getElementById('reservationDetails').innerHTML = `
                <p><strong>N¬∞ R√©servation:</strong> #${r.id}</p>
                <p><strong>Atelier:</strong> ${r.atelierTitre}</p>
                <p><strong>Date:</strong> ${r.atelierDate}</p>
                <p><strong>Horaire:</strong> ${r.atelierHeure}</p>
                <hr style="margin: 15px 0;">
                <p><strong>Parent:</strong> ${r.parentNom}</p>
                <p><strong>Email:</strong> ${r.parentEmail}</p>
                <p><strong>T√©l√©phone:</strong> ${r.parentTel}</p>
                <p><strong>Enfant:</strong> ${r.enfantPrenom} (${r.enfantAge} ans)</p>
                ${r.parentParticipant ? `<p><strong>Parent participant:</strong> ${r.parentParticipant}</p>` : ''}
                ${r.message ? `<p><strong>Message:</strong> ${r.message}</p>` : ''}
                <hr style="margin: 15px 0;">
                <p><strong>R√©serv√© le:</strong> ${r.dateReservation}</p>
                <p><strong>Statut:</strong> <span class="status-badge status-${r.statut}">${r.statut}</span></p>
            `;
            
            document.getElementById('modalDetails').classList.add('active');
        }
        
        function closeDetailsModal() {
            document.getElementById('modalDetails').classList.remove('active');
        }
        
        function cancelReservation(id) {
            if (!confirm('Voulez-vous vraiment annuler cette r√©servation ?')) return;
            
            const r = reservations.find(res => res.id === id);
            if (r) {
                r.statut = 'annul√©e';
                
                // Rendre la place
                const source = r.atelierType === 'solo' ? ateliersData.ateliersSolo : ateliersData.ateliersDuo;
                const atelier = source.find(a => a.id === r.atelierId);
                if (atelier) {
                    atelier.placesRestantes++;
                    atelier.complet = false;
                }
                
                saveData();
                renderReservations();
                renderAteliers();
                updateStats();
                showToast('‚úÖ R√©servation annul√©e', 'warning');
            }
        }
        
        // =============================================
        // EXPORT
        // =============================================
        
        function exportReservations() {
            if (reservations.length === 0) {
                showToast('‚ùå Aucune r√©servation √† exporter', 'error');
                return;
            }
            
            let csv = 'N¬∞,Atelier,Date,Horaire,Parent,Email,T√©l√©phone,Enfant,Age,Statut,Date R√©servation\n';
            
            reservations.forEach(r => {
                csv += `${r.id},"${r.atelierTitre}","${r.atelierDate}","${r.atelierHeure}","${r.parentNom}","${r.parentEmail}","${r.parentTel}","${r.enfantPrenom}",${r.enfantAge},"${r.statut}","${r.dateReservation}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reservations-eveil-vous-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('‚úÖ Export CSV t√©l√©charg√©', 'success');
        }
        
        // =============================================
        // PARAM√àTRES
        // =============================================
        
        function saveSettings() {
            showToast('‚úÖ Param√®tres sauvegard√©s', 'success');
        }
        
        async function resetAllData() {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer TOUTES les donn√©es ?')) return;
            if (!confirm('üö® Cette action est irr√©versible ! Confirmer ?')) return;
            
            localStorage.removeItem('ateliers-reservations-data');
            localStorage.removeItem('reservations-list');
            localStorage.removeItem('waitlist-data');
            
            ateliersData = JSON.parse(JSON.stringify(defaultData));
            reservations = [];
            waitlistData = [];
            
            await saveData();
            renderAteliers();
            renderReservations();
            renderWaitlist();
            updateStats();
            
            showToast('‚úÖ Donn√©es r√©initialis√©es', 'warning');
        }
        
        // Fonctions Firebase
        async function syncFromFirebase() {
            if (!firebaseReady) {
                showToast('‚ùå Firebase non connect√©', 'error');
                return;
            }
            
            showToast('üîÑ Synchronisation...', 'success');
            await loadData();
            renderAteliers();
            renderReservations();
            renderWaitlist();
            updateStats();
            showToast('‚úÖ Donn√©es synchronis√©es depuis Firebase', 'success');
        }
        
        async function migrateToFirebase() {
            if (!firebaseReady) {
                showToast('‚ùå Firebase non connect√©', 'error');
                return;
            }
            
            if (!confirm('Migrer toutes les donn√©es locales vers Firebase ?')) return;
            
            showToast('üîÑ Migration en cours...', 'success');
            
            try {
                await FirebaseDB.migrateFromLocalStorage();
                showToast('‚úÖ Migration vers Firebase termin√©e !', 'success');
            } catch (e) {
                console.error('Erreur migration:', e);
                showToast('‚ùå Erreur lors de la migration', 'error');
            }
        }
        
        function updateFirebaseStatusBox() {
            const box = document.getElementById('firebaseStatusBox');
            const text = document.getElementById('firebaseStatusText');
            
            if (firebaseReady) {
                box.style.background = '#F0FDF4';
                box.style.borderColor = '#10B981';
                text.textContent = 'Connect√© - Donn√©es synchronis√©es en temps r√©el';
                text.style.color = '#065F46';
            } else {
                box.style.background = '#FEF3C7';
                box.style.borderColor = '#F59E0B';
                text.textContent = 'Mode hors-ligne - Donn√©es stock√©es localement';
                text.style.color = '#92400E';
            }
        }
        
        // =============================================
        // LISTE D'ATTENTE
        // =============================================
        
        function renderWaitlist() {
            const tbody = document.getElementById('waitlistBody');
            const emptyState = document.getElementById('emptyWaitlist');
            
            if (waitlistData.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = waitlistData.map(w => `
                <tr>
                    <td><strong>${w.atelierTitre}</strong></td>
                    <td>${w.atelierDate}</td>
                    <td>${w.nom}</td>
                    <td><a href="mailto:${w.email}">${w.email}</a></td>
                    <td>${w.tel || '-'}</td>
                    <td>${w.dateInscription}</td>
                    <td>
                        <span class="status-badge ${w.notified ? 'status-confirmee' : 'status-attente'}">
                            ${w.notified ? '‚úÖ Notifi√©' : '‚è≥ En attente'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-small btn-edit" onclick="notifyWaitlistPerson('${w.id}')">üìß Notifier</button>
                        <button class="btn-small btn-complet" onclick="removeFromWaitlistAdmin('${w.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function notifyWaitlistPerson(id) {
            const person = waitlistData.find(w => w.id === id || w.id === parseInt(id));
            
            if (!person) return;
            
            // Marquer comme notifi√©
            person.notified = true;
            localStorage.setItem('waitlist-data', JSON.stringify(waitlistData));
            
            // Sauvegarder dans Firebase si disponible
            if (firebaseReady && person.id) {
                try {
                    await db.collection('waitlist').doc(String(person.id)).update({ notified: true });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erreur mise √† jour Firebase waitlist');
                }
            }
            
            // Envoyer email (simulation - utiliser EmailJS en production)
            const subject = encodeURIComponent(`üéâ Une place s'est lib√©r√©e - ${person.atelierTitre}`);
            const body = encodeURIComponent(`Bonjour ${person.nom},\n\nBonne nouvelle ! Une place s'est lib√©r√©e pour l'atelier "${person.atelierTitre}" du ${person.atelierDate}.\n\nR√©servez vite sur notre site !\n\n√âveil & Vous`);
            window.open(`mailto:${person.email}?subject=${subject}&body=${body}`);
            
            renderWaitlist();
            showToast('üìß Email de notification ouvert', 'success');
        }
        
        async function removeFromWaitlistAdmin(id) {
            if (!confirm('Supprimer cette inscription de la liste d\'attente ?')) return;
            
            waitlistData = waitlistData.filter(w => w.id !== id && w.id !== parseInt(id));
            localStorage.setItem('waitlist-data', JSON.stringify(waitlistData));
            
            // Supprimer de Firebase si disponible
            if (firebaseReady) {
                try {
                    await FirebaseDB.removeFromWaitlist(String(id));
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erreur suppression Firebase waitlist');
                }
            }
            
            renderWaitlist();
            showToast('‚úÖ Supprim√© de la liste d\'attente', 'success');
        }
        
        // =============================================
        // EMAILING GROUP√â
        // =============================================
        
        function populateEmailAtelierSelect() {
            const select = document.getElementById('emailAtelierId');
            const allAteliers = [...ateliersData.ateliersSolo, ...ateliersData.ateliersDuo];
            
            allAteliers.forEach(a => {
                const option = document.createElement('option');
                option.value = a.id;
                option.textContent = `${a.emoji} ${a.titre} - ${a.date}`;
                select.appendChild(option);
            });
        }
        
        function updateEmailRecipients() {
            const atelierId = document.getElementById('emailAtelierId').value;
            const infoDiv = document.getElementById('emailRecipientsInfo');
            const countSpan = document.getElementById('emailRecipientsCount');
            const listDiv = document.getElementById('emailRecipientsList');
            
            if (!atelierId) {
                infoDiv.style.display = 'none';
                return;
            }
            
            let recipients = [];
            
            if (atelierId === 'all') {
                recipients = reservations.filter(r => r.statut === 'confirmee');
            } else {
                recipients = reservations.filter(r => r.atelierId == atelierId && r.statut === 'confirmee');
            }
            
            infoDiv.style.display = 'block';
            countSpan.textContent = recipients.length;
            
            if (recipients.length > 0) {
                listDiv.innerHTML = recipients.map(r => r.parentEmail).join(', ');
            } else {
                listDiv.innerHTML = '<em>Aucun inscrit pour cet atelier</em>';
            }
        }
        
        function sendGroupEmail() {
            const atelierId = document.getElementById('emailAtelierId').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            
            if (!atelierId) {
                showToast('‚ùå S√©lectionnez un atelier', 'error');
                return;
            }
            
            if (!subject || !message) {
                showToast('‚ùå Remplissez l\'objet et le message', 'error');
                return;
            }
            
            let recipients = [];
            let atelier = null;
            
            if (atelierId === 'all') {
                recipients = reservations.filter(r => r.statut === 'confirmee');
            } else {
                recipients = reservations.filter(r => r.atelierId == atelierId && r.statut === 'confirmee');
                atelier = [...ateliersData.ateliersSolo, ...ateliersData.ateliersDuo].find(a => a.id == atelierId);
            }
            
            if (recipients.length === 0) {
                showToast('‚ùå Aucun destinataire', 'error');
                return;
            }
            
            // Pr√©parer les emails
            const emailList = recipients.map(r => r.parentEmail).join(',');
            
            // Remplacer les variables par des exemples pour le premier destinataire
            let finalMessage = message
                .replace(/{nom}/g, '[Nom du parent]')
                .replace(/{enfant}/g, '[Pr√©nom enfant]')
                .replace(/{atelier}/g, atelier ? atelier.titre : '[Atelier]')
                .replace(/{date}/g, atelier ? atelier.date : '[Date]')
                .replace(/{heure}/g, atelier ? atelier.heure : '[Horaire]');
            
            // Ouvrir le client mail avec tous les destinataires en BCC
            const mailtoLink = `mailto:?bcc=${encodeURIComponent(emailList)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalMessage)}`;
            window.open(mailtoLink);
            
            showToast(`üìß Email group√© pr√©par√© pour ${recipients.length} personne(s)`, 'success');
        }
        
        // =============================================
        // UTILITAIRES
        // =============================================
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            document.getElementById('toastIcon').textContent = type === 'success' ? '‚úÖ' : (type === 'error' ? '‚ùå' : '‚ö†Ô∏è');
            toast.className = `toast ${type} show`;
            
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        function logout() {
            logoutAdmin();
        }
        
        // =============================================
        // LANCEMENT
        // =============================================
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
